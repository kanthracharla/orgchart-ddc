<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Org Chart DDC</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; }
    svg { background: #edf7ed; }
    .node rect {
      fill: #9bcc9b;
      stroke: #336633;
      stroke-width: 2;
      rx: 5;
      ry: 5;
      width: 120px;
      height: 60px;
    }
    .node text {
      font: 14px sans-serif;
      pointer-events: none;
    }
    .tooltip {
      position: absolute;
      text-align: center;
      padding: 8px;
      font: 12px sans-serif;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
  </style>
</head>
<body>
  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <!-- D3 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <script>
    const svg = d3.select("#chart").append("svg")
      .attr("width", "100%").attr("height", "100%");
    const container = svg.append("g");
    const zoom = d3.zoom().on("zoom", (e) => container.attr("transform", e.transform));
    svg.call(zoom);

    const tooltip = d3.select("#tooltip");

    function renderOrgChart(nodesData) {
      container.selectAll("*").remove();
      const root = d3.hierarchy(nodesData)
        .sum(d => d.quantity)
        .sort((a,b) => d3.descending(a.value, b.value));

      const tree = d3.tree().nodeSize([180, 120]);
      tree(root);

      container.selectAll(".link")
        .data(root.links())
        .enter().append("path")
          .attr("class","link")
          .attr("fill","none")
          .attr("stroke","#888")
          .attr("d", d3.linkHorizontal()
                       .x(d => d.y)
                       .y(d => d.x));

      const node = container.selectAll(".node")
        .data(root.descendants())
        .enter().append("g")
          .attr("class","node")
          .attr("transform", d => `translate(${d.y},${d.x})`)
          .on("click", onNodeClick)
          .on("mouseover", (e,d) => tooltip
            .html(`${d.data.name}<br>QUANTITY â€” ${d.data.quantity}`)
            .style("opacity",1))
          .on("mousemove", e => tooltip
            .style("left", (e.pageX + 10) + "px")
            .style("top", (e.pageY + 10) + "px"))
          .on("mouseout", () => tooltip.style("opacity",0));

      node.append("rect")
          .attr("x", -60).attr("y", -30);

      node.append("text")
          .attr("dy", "-5")
          .attr("text-anchor", "middle")
          .text(d => d.data.name);

      node.append("text")
          .attr("dy", "15")
          .attr("text-anchor", "middle")
          .text(d => d.data.quantity.toLocaleString());
    }

    function onNodeClick(event, d) {
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
      renderOrgChart(rootData);
    }

    function transformVA(resultData) {
      const rows = resultData.data;
      const cols = resultData.columns;
      const stIndex = cols.findIndex(c => c.name.toLowerCase()==="state");
      const ctIndex = cols.findIndex(c => c.name.toLowerCase()==="category");
      const qtIndex = cols.findIndex(c => c.name.toLowerCase()==="quantity");
      const flat = rows.map(r => ({ state: r[stIndex], category: r[ctIndex], quantity: +r[qtIndex] }));
      const byState = d3.groups(flat, d => d.state)
                         .map(([state, items]) => ({
                           name: state,
                           children: items.map(i => ({ name: i.category, quantity: i.quantity })),
                           quantity: d3.sum(items, i => i.quantity)
                         }));
      return { name: "All Products", quantity: d3.sum(byState, d => d.quantity), children: byState };
    }

    function showFallback() {
      renderOrgChart({
        name: "All Products", quantity: 0,
        children: [
          { name: "IL", quantity: 18000, children: [
            {name: "Flower", quantity: 10000},
            {name: "Vape", quantity: 8000}
          ]},
          { name: "MN", quantity: 5000, children: [
            {name: "Edible", quantity: 5000}
          ]}
        ]
      });
    }

    let rendered = false;

    window.addEventListener("message", event => {
      if (event.data && event.data.va) {
        const nodes = transformVA(event.data.va.resultData);
        renderOrgChart(nodes);
        rendered = true;
      }
    });

    window.addEventListener("load", () => {
      setTimeout(() => {
        if (!rendered) {
          showFallback();
        }
      }, 500);
    });

  </script>
</body>
</html>
