
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Org Chart - SAS VA DDC</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://unpkg.com/va-report-components@latest/dist/va-report-components.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      overflow: hidden;
    }

    svg {
      width: 100vw;
      height: 100vh;
    }

    .node rect {
      stroke: #999;
      stroke-width: 1.5px;
      rx: 10;
      ry: 10;
    }

    .node text {
      pointer-events: none;
      font-size: 12px;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
  </style>
</head>
<body>
<svg></svg>

<script>
let fallbackData = [
  { state: "California", category: "Chocolate", quantity: 120 },
  { state: "California", category: "Tablet", quantity: 80 },
  { state: "Texas", category: "Capsule", quantity: 60 },
  { state: "Texas", category: "Gummy", quantity: 140 },
  { state: "New York", category: "Drop", quantity: 90 }
];

function renderChart(data) {
  const svg = d3.select("svg");
  svg.selectAll("*").remove();

  const width = window.innerWidth;
  const height = window.innerHeight;

  const root = d3.stratify()
    .id((d, i) => d.state + "-" + d.category)
    .parentId(d => d.state)(data);

  const treeLayout = d3.tree().size([height - 40, width - 160]);
  const treeRoot = d3.hierarchy(root).sum(d => d.quantity);
  const tree = treeLayout(treeRoot);

  const g = svg.append("g").attr("transform", "translate(80,20)");

  const link = g.selectAll(".link")
    .data(tree.links())
    .enter()
    .append("path")
    .attr("class", "link")
    .attr("d", d3.linkHorizontal()
      .x(d => d.y)
      .y(d => d.x));

  const node = g.selectAll(".node")
    .data(tree.descendants())
    .enter()
    .append("g")
    .attr("class", "node")
    .attr("transform", d => `translate(${d.y},${d.x})`);

  node.append("rect")
    .attr("width", 100)
    .attr("height", 40)
    .attr("x", -50)
    .attr("y", -20)
    .attr("fill", d => d.children ? "#c6e2ff" : "#e0ffe0");

  node.append("text")
    .attr("dy", "0")
    .attr("text-anchor", "middle")
    .text(d => `${d.data.id.split("-")[1] || d.data.id}`);

  node.append("text")
    .attr("dy", "1.2em")
    .attr("text-anchor", "middle")
    .attr("font-size", "10px")
    .text(d => d.data.data.quantity || "");
}

function handleVAData(vaData) {
  if (!vaData || !vaData.rows || vaData.rows.length === 0) {
    renderChart(fallbackData);
    return;
  }

  const columns = vaData.columns.map(c => c.name.toLowerCase());
  const stateIdx = columns.indexOf("state");
  const catIdx = columns.indexOf("category");
  const qtyIdx = columns.indexOf("quantity");

  const rows = vaData.rows.map(row => ({
    state: row[stateIdx],
    category: row[catIdx],
    quantity: +row[qtyIdx]
  }));

  renderChart(rows);
}

if (typeof va !== "undefined") {
  va.ready().then(() => {
    va.on("data", handleVAData);
  });
} else {
  renderChart(fallbackData);
}
</script>
</body>
</html>
