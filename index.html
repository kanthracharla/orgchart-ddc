
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Org Chart DDC</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #eef6ec;
      font-family: Arial, sans-serif;
    }
    .node rect {
      fill: #a3d9a5;
      stroke: #333;
      stroke-width: 1px;
      rx: 12;
      ry: 12;
    }
    .node text {
      font-size: 14px;
      text-anchor: middle;
      dominant-baseline: middle;
    }
    svg {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <svg id="chart"></svg>
  <script>
    const svg = d3.select("#chart");
    const g = svg.append("g");

    const width = window.innerWidth;
    const height = window.innerHeight;

    const zoom = d3.zoom()
      .scaleExtent([0.5, 2])
      .on("zoom", (event) => g.attr("transform", event.transform));
    svg.call(zoom);

    function buildTreeFromFlatData(data) {
      const grouped = d3.group(data, d => d.state, d => d.category);
      const root = {
        name: "All Products",
        children: []
      };

      for (const [state, stateGroup] of grouped.entries()) {
        const stateNode = {
          name: state,
          children: []
        };
        let stateQty = 0;

        for (const [category, entries] of stateGroup.entries()) {
          const total = d3.sum(entries, d => d.quantity);
          stateNode.children.push({
            name: category,
            quantity: total
          });
          stateQty += total;
        }

        stateNode.quantity = stateQty;
        root.children.push(stateNode);
      }

      return root;
    }

    function drawChart(treeData) {
      svg.selectAll("*").remove(); // clear before drawing
      const root = d3.hierarchy(treeData);
      const treeLayout = d3.tree().nodeSize([160, 100]);
      treeLayout(root);

      const g = svg.append("g").attr("transform", "translate(50,50)");

      g.selectAll(".link")
        .data(root.links())
        .join("path")
        .attr("fill", "none")
        .attr("stroke", "#999")
        .attr("d", d3.linkVertical()
          .x(d => d.x)
          .y(d => d.y));

      const node = g.selectAll(".node")
        .data(root.descendants())
        .join("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x},${d.y})`);

      node.append("rect")
        .attr("x", -75)
        .attr("y", -30)
        .attr("width", 150)
        .attr("height", 60)
        .attr("rx", 12)
        .attr("ry", 12);

      node.append("text")
        .attr("dy", -5)
        .text(d => d.data.name);

      node.append("text")
        .attr("dy", 15)
        .text(d => d.data.quantity !== undefined ? `QUANTITY â€” ${d3.format(",")(d.data.quantity)}` : "");
    }

    function initChart() {
      if (window._va_data && _va_data.length > 0) {
        const flatData = _va_data.map(row => ({
          state: row.state || "Unknown",
          category: row.category || "Unknown",
          quantity: +row.quantity || 0
        }));
        const tree = buildTreeFromFlatData(flatData);
        drawChart(tree);
      } else {
        // fallback static test data
        const testData = [
          { state: "IL", category: "Flower", quantity: 10000 },
          { state: "IL", category: "Vape", quantity: 8000 },
          { state: "MN", category: "Edible", quantity: 5000 }
        ];
        const tree = buildTreeFromFlatData(testData);
        drawChart(tree);
      }
    }

    window.addEventListener("load", () => {
      setTimeout(initChart, 500);
    });
  </script>
</body>
</html>
