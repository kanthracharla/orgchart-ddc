
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Org Chart DDC</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
    }
    svg {
      width: 100%;
      height: 100vh;
    }
    .node rect {
      fill: #cce5ff;
      stroke: #004085;
      stroke-width: 1px;
      rx: 10;
      ry: 10;
    }
    .node text {
      fill: #000;
      font-size: 12px;
    }
    .link {
      fill: none;
      stroke: #aaa;
      stroke-width: 1.5px;
    }
  </style>
</head>
<body>
  <svg></svg>

  <script>
    function drawFromFlatData(data) {
      const nested = d3.groups(data, d => d.state, d => d.category).map(([state, categories]) => ({
        name: state,
        children: categories.map(([cat, items]) => ({
          name: cat,
          value: d3.sum(items, d => d.qty)
        }))
      }));

      renderOrgChart(nested);
    }

    function renderOrgChart(data) {
      d3.select("svg").selectAll("*").remove();

      const root = d3.hierarchy({ name: "root", children: data })
        .sum(d => d.value || 0)
        .sort((a, b) => (b.value || 0) - (a.value || 0));

      const treeLayout = d3.tree().nodeSize([150, 120]);
      treeLayout(root);

      const svg = d3.select("svg")
        .call(d3.zoom().on("zoom", function (event) {
          svg.attr("transform", event.transform);
        }))
        .append("g")
        .attr("transform", "translate(100,50)");

      svg.selectAll(".link")
        .data(root.links())
        .join("path")
        .attr("class", "link")
        .attr("d", d3.linkVertical()
          .x(d => d.x)
          .y(d => d.y));

      const node = svg.selectAll(".node")
        .data(root.descendants())
        .join("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x},${d.y})`);

      node.append("rect")
        .attr("x", -60)
        .attr("y", -20)
        .attr("width", 120)
        .attr("height", 40)
        .attr("fill", "#e0f7fa");

      node.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", "-0.2em")
        .text(d => d.data.name);

      node.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", "1em")
        .text(d => d.value !== undefined ? `${d.value}` : "");
    }

    // Fallback data
    function showFallback() {
      drawFromFlatData([
        { state: "IL", category: "Flower", qty: 10000 },
        { state: "IL", category: "Vape", qty: 8000 },
        { state: "MN", category: "Edible", qty: 5000 }
      ]);
    }

    // Listen for VA messages
    window.addEventListener("message", function(event) {
      if (event.data && event.data.va && event.data.va.resultData) {
        const vaResult = event.data.va.resultData;
        console.log("Received data from VA:", vaResult);

        const rows = vaResult.map((row) => ({
          category: row.category,
          state: row.state,
          qty: +row.quantity
        }));

        window._va_data_received = true;
        drawFromFlatData(rows);
      } else {
        console.warn("No VA data received. Showing fallback.");
        showFallback();
      }
    });

    // Timeout fallback in case VA data is not received
    setTimeout(() => {
      if (!window._va_data_received) {
        showFallback();
      }
    }, 2000);
  </script>
</body>
</html>
