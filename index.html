<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DDC Org Chart</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #e8f5e9;
    }
    svg {
      width: 100%;
      height: 100vh;
    }
    .node rect {
      fill: #aed581;
      stroke: #33691e;
      stroke-width: 1.5px;
      rx: 6;
      ry: 6;
    }
    .node text {
      font-size: 13px;
      fill: #1b5e20;
      pointer-events: none;
    }
    .link {
      fill: none;
      stroke: #9ccc65;
      stroke-width: 2px;
    }
  </style>
</head>
<body>
  <svg></svg>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="messagingUtil.js"></script>
  <script src="contentUtil.js"></script>
  <script>
    const svg = d3.select("svg"),
      width = window.innerWidth,
      height = window.innerHeight,
      g = svg.append("g").attr("transform", "translate(40,0)");

    const tree = d3.tree().nodeSize([100, 220]);
    const stratify = d3.stratify().id(d => d.id).parentId(d => d.parentId);

    const zoom = d3.zoom().on("zoom", function (event) {
      g.attr("transform", event.transform);
    });
    svg.call(zoom);

    function render(data) {
      g.selectAll("*").remove();

      const root = stratify(data);
      tree(root);

      const link = g.selectAll(".link")
        .data(root.links())
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("d", d3.linkHorizontal()
          .x(d => d.y)
          .y(d => d.x)
        );

      const node = g.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.y},${d.x})`);

      node.append("rect")
        .attr("x", -60)
        .attr("y", -20)
        .attr("width", 120)
        .attr("height", 40)
        .attr("rx", 6)
        .attr("ry", 6);

      node.append("text")
        .attr("dy", -5)
        .attr("text-anchor", "middle")
        .text(d => d.data.name);

      node.append("text")
        .attr("dy", 12)
        .attr("text-anchor", "middle")
        .text(d => `Qty: ${d.data.quantity}`);
    }

    function transformData(table) {
      const nodes = [];
      const seenStates = new Set();

      table.data.forEach(row => {
        const state = row[table.columns.indexOf("state")];
        const category = row[table.columns.indexOf("category")];
        const quantity = row[table.columns.indexOf("quantity")];

        if (!seenStates.has(state)) {
          seenStates.add(state);
          nodes.push({ id: state, parentId: "root", name: state, quantity: "" });
        }
        nodes.push({ id: `${state}_${category}`, parentId: state, name: category, quantity });
      });

      nodes.push({ id: "root", parentId: "", name: "States", quantity: "" });
      return nodes;
    }

    function fallback() {
      const dummy = [
        { id: "root", parentId: "", name: "States", quantity: "" },
        { id: "IL", parentId: "root", name: "IL", quantity: "" },
        { id: "MN", parentId: "root", name: "MN", quantity: "" },
        { id: "IL_Edibles", parentId: "IL", name: "Edibles", quantity: 123 },
        { id: "IL_Tinctures", parentId: "IL", name: "Tinctures", quantity: 89 },
        { id: "MN_Topicals", parentId: "MN", name: "Topicals", quantity: 55 },
        { id: "MN_Oils", parentId: "MN", name: "Oils", quantity: 72 },
      ];
      render(dummy);
    }

    if (typeof va !== "undefined") {
      va.messagingUtil.setOnDataReceivedCallback(function (data) {
        if (data && data.data && data.data.length > 0) {
          const parsed = transformData(data);
          render(parsed);
        } else {
          fallback();
        }
      });
    } else {
      fallback();
    }
  </script>
</body>
</html>
